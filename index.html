<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>What is zone.js and how does it work with Angular?</title>

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/sky.css">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <link rel="stylesheet" href="css/custom.css">

    <!-- Printing and PDF exports -->
    <script>
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>
  </head>
  <body>
    <div class="reveal custom">
      <div class="slides">
        <section>
          <h1>What is zone.js<br>and<br>how does it work with Angular?</h1>
          <h2 style="margin-top:3em">David Stanich</h2>
        </section>

        <section>
          <h1>About Me</h1>
          <h2 style="margin:0">David Stanich</h2>
          <div style="font-size:.7em;margin:0">
            | Github: <a href="https://github.com/dstanich" target="_blank">dstanich</a> | Twitter: <a href="https://twitter.com/dstanich" target="_blank">@dstanich</a> |
          </div>
          <ul style="margin-top:1em">
            <li>Software Engineer @ IBM Watson Health</li>
            <li style="margin-top:.5em"><strong>AngularJS</strong>: several years with multiple apps</li>
            <li><strong>Angular</strong>: migration started this year</li>
          </ul>
        </section>

        <section>
          <section>
            <h1>Angular 101</h1>
            <pre><code data-trim data-noescape class="bash">
# Install angular-cli
npm install -g @angular/cli

# Create brand new project
ng new my-new-project

# What did that command just do?
cat package.json
            </code></pre>
          </section>

          <section>
            <h1>Angular stuff - makes sense</h1>
            <pre><code data-trim data-noescape class="json">
"dependencies": {
<mark>  "@angular/animations": "^4.2.4",
  "@angular/common": "^4.2.4",
  "@angular/compiler": "^4.2.4",
  "@angular/core": "^4.2.4",
  "@angular/forms": "^4.2.4",
  "@angular/http": "^4.2.4",
  "@angular/platform-browser": "^4.2.4",
  "@angular/platform-browser-dynamic": "^4.2.4",
  "@angular/router": "^4.2.4",</mark>
  "core-js": "^2.4.1",
  "rxjs": "^5.4.2",
  "zone.js": "^0.8.14"
},
            </code></pre>
          </section>

          <section>
            <h1>Libraries - Seem familiar</h1>
            <pre><code data-trim data-noescape class="json">
"dependencies": {
  "@angular/animations": "^4.2.4",
  "@angular/common": "^4.2.4",
  "@angular/compiler": "^4.2.4",
  "@angular/core": "^4.2.4",
  "@angular/forms": "^4.2.4",
  "@angular/http": "^4.2.4",
  "@angular/platform-browser": "^4.2.4",
  "@angular/platform-browser-dynamic": "^4.2.4",
  "@angular/router": "^4.2.4",
<mark>  "core-js": "^2.4.1",
  "rxjs": "^5.4.2",</mark>
  "zone.js": "^0.8.14"
},
            </code></pre>
          </section>

          <section>
            <h1>zone.js - What the heck is that?</h1>
            <pre><code data-trim data-noescape class="json">
"dependencies": {
  "@angular/animations": "^4.2.4",
  "@angular/common": "^4.2.4",
  "@angular/compiler": "^4.2.4",
  "@angular/core": "^4.2.4",
  "@angular/forms": "^4.2.4",
  "@angular/http": "^4.2.4",
  "@angular/platform-browser": "^4.2.4",
  "@angular/platform-browser-dynamic": "^4.2.4",
  "@angular/router": "^4.2.4",
  "core-js": "^2.4.1",
  "rxjs": "^5.4.2",
<mark>  "zone.js": "^0.8.14"</mark>
},
            </code></pre>
          </section>
        </section>

        <section>
          <h1>So why is it there?</h1>
          <div style="text-align:left;font-size:.7em">Short answer:</div>
          <div style="font-size:2em;">Change detection</div>
          <div style="margin-top:3em;">Keep this in mind over the next slides</div>
        </section>

        <section>
          <section>
            <h1>zone.js</h1>
            <div style="font-size: .9em">A Zone is an execution context that persists across async tasks, and allows the creator of the zone to <strong>observe</strong> and <strong>control</strong> execution of the code within the zone.</div>
            <div style="font-size: .75em;text-align:right;"><a href="https://docs.google.com/document/d/1F5Ug0jcrm031vhSMJEOgp1l-Is-Vf0UCNDY-LsQtAIY/edit#" target="_blank">- Zone Primer Doc</a></div>
            <div style="margin-top:2em">Proposed for <a href="https://github.com/tc39/proposals/blob/master/stage-0-proposals.md" target="_blank">EcmaScript</a>, currently blocked</div>
            <div style="margin-top:2em;">
              | <a href="https://github.com/angular/zone.js" target="_blank">zone.js Github</a>| <a href="https://github.com/angular/zone.js/blob/master/dist/zone.js.d.ts" target="_blank">zone.js API</a> | <a href="https://docs.google.com/document/d/1F5Ug0jcrm031vhSMJEOgp1l-Is-Vf0UCNDY-LsQtAIY/edit#" target="_blank">Zone Primer Doc</a> |
            </div>
          </section>
          <section>
            <h1>What can it do?</h1>
            <ul>
              <li>Defines async tasks into types</li>
              <li>Monkey patches async browser APIs</li>
              <li>Create new (forked) zones and manage context</li>
              <li>Control what zone code runs inside</li>
              <li>Observe start, stop, scheduling of tasks</li>
            </ul>
          </section>
          <section>
            <h1>Event Types</h1>
            <table style="font-size: .7em; margin-top: 1em;">
              <thead>
                <th>Type</th>
                <th>Usage</th>
                <th>Example</th>
              </thead>
              <tbody>
                <tr>
                  <td><span class="terminal">Microtask</span></td>
                  <td>Guaranteed to run once and immediately</td>
                  <td>promise.then()</td>
                </tr>
                <tr>
                  <td><span class="terminal">Macrotask</span></td>
                  <td>Returns value of property with given key</td>
                  <td>Work to be done later that is not guaranteed to run.  Able to cancel.</td>
                </tr>
                <tr>
                  <td><span class="terminal">EventTask</span></td>
                  <td>Searches parents for zone with given key</td>
                  <td>MouseClick, KeyboardEvent, 'on' properties, ...</td>
                </tr>
              </tbody>
            </table>
          </section>
          <section>
            <h1>Monkey patched APIs</h1>
            <div style="text-align:left;font-size:.6em"><strong>Monkey patching</strong></div>
            <div style="font-size: .9em;text-align:left;margin-left:.5em;margin-right:.5em">Override a function to execute your own code as part of any future calls to the function.</div>
            <div style="text-align:left;font-size:.6em;margin-top:1em"><strong>zone.js</strong></div>
            <div style="text-align:left;margin-left:.5em;margin-right:.5em;">
              <ul>
                <li>Patches all browser async APIs</li>
                <li>fetch(), setTimeout(), mouse events, ...</li>
                <li><a href="https://github.com/angular/zone.js/blob/master/STANDARD-APIS.md" target="_blank">All patched APIs</a></li>
              </ul>
            </div>
          </section>
          <section>
            <h1>Managing zones</h1>
            <ul>
              <li>Always a <strong>root</strong> zone by default</li>
              <li>Ability to create new child zones</li>
              <li>Store shallow immutable properties</li>
            </ul>
            <table style="font-size: .7em; margin-top: 1em;">
              <thead>
                <th>API</th>
                <th>Usage</th>
              </thead>
              <tbody>
                <tr>
                  <td><span class="terminal">Zone.current</span></td>
                  <td>Returns currently active zone</td>
                </tr>
                <tr>
                  <td><span class="terminal">zoneObj.fork(ZoneSpec)</span></td>
                  <td>Create a new child zone.  <a href="https://github.com/angular/zone.js/blob/master/dist/zone.js.d.ts#L288" target="_blank">ZoneSpec</a></td>
                </tr>
                <tr>
                  <td><span class="terminal">zoneObj.get(key)</span></td>
                  <td>Returns value of property with given key</td>
                </tr>
                <tr>
                  <td><span class="terminal">zoneObj.getZoneWith(key)</span></td>
                  <td>Searches parents for zone with given key</td>
                </tr>
              </tbody>
            </table>
          </section>
          <section>
            <h1>Controlling what runs in a zone</h1>
            <ul>
              <li>Execute/schedule code within a specific zone</li>
              <li>Segments code so it's easier to control</li>
              <li>Consolidated error handling</li>
            </ul>
            <table style="font-size: .7em; margin-top: 1em;">
              <thead>
                <th>API</th>
                <th>Usage</th>
              </thead>
              <tbody>
                <tr>
                  <td><span class="terminal">zoneObj.run(fn)</span></td>
                  <td>Run function within zoneObj</td>
                </tr>
                <tr>
                  <td><span class="terminal">zoneObj.runGuarded(fn)</span></td>
                  <td>Run function within zoneObj and catch all exceptions</td>
                </tr>
                <tr>
                  <td><span class="terminal">zoneObj.wrap(fn)</span></td>
                  <td>Returns function wrapping fn and restoring zone and this</td>
                </tr>
              </tbody>
            </table>
          </section>
          <section>
            <h1>Observing with zone hooks</h1>
            <div style="font-size:.8em">Part of the ZoneSpec.  Define handlers for what you need.</div>
            <table style="font-size: .7em; margin-top: 1em;">
              <thead>
                <th>Hook</th>
                <th>Usage</th>
              </thead>
              <tbody>
                <tr>
                  <td><span class="terminal">onFork</span></td>
                  <td>Called when the zone is forked.</td>
                </tr>
                <tr>
                  <td><span class="terminal">onIntercept</span></td>
                  <td>Called when wrap() is called</td>
                </tr>
                <tr>
                  <td><span class="terminal">onInvoke</span></td>
                  <td>Called when run() callback is executed</td>
                </tr>
                <tr>
                  <td><span class="terminal">onHandleError</span></td>
                  <td>Called when an error is </td>
                </tr>
                <tr>
                  <td><span class="terminal">onScheduleTask</span></td>
                  <td>Called when a task is scheduled</td>
                </tr>
                <tr>
                  <td><span class="terminal">onInvokeTask</span></td>
                  <td>Called when a scheduled task is run</td>
                </tr>
                <tr>
                  <td><span class="terminal">onCancelTask</span></td>
                  <td>Called when a scheduled task is canceled</td>
                </tr>
                <tr>
                  <td><span class="terminal">onHasTask</span></td>
                  <td>Called when a task queue is modified</td>
                </tr>
              </tbody>
            </table>
          </section>
        </section>

        <section>
          <h1>zone.js Demos</h1>
          <div style="font-size: .7em">
            <a href="https://github.com/dstanich/zonejs-presentation#branches" target="_blank">Source - js-examples/</a>
          </div>
        </section>

        <section>
          <section>
            <h1>Angular and zone.js</h1>
            <div style="margin-top:1em;">Angular uses zone.js for intelligently kicking off change detection on components.</div>
            <div style="margin-top:2em;">State is changed in applications by async tasks.  zone.js allows Angular to detect and react to them.</div>
          </section>
          <section>
            <h1>How does it work?</h1>
            <ul>
              <li>Angular creates fork: NgZone</li>
              <li>All code runs within NgZone</li>
              <li><a href="https://angular.io/api/core/NgZone" target="_blank">NgZone API</a> to observe and control</li>
              <li>Provides better stack traces via <a href="https://github.com/angular/zone.js/blob/master/dist/long-stack-trace-zone.js" target="_blank">long stack trace zone</a></li>
            </ul>
          </section>
          <section>
            <h1>Angular triggering change detection</h1>
            <a style="font-size:.75em" href="https://github.com/angular/angular/blob/9bbf009dff002cc4d100a52872fa609874e49d26/packages/core/src/application_ref.ts" target="_blank">application_ref.ts:</a>
            <pre><code data-trim data-noescape class="ts">
constructor() {
  this._zone.onMicrotaskEmpty.subscribe(
    {next: () => { this._zone.run(() => { this.tick(); }); }});
}

/**
  * Invoke this method to explicitly process change detection
  * and its side-effects.
  * ...
  */
tick(): void {
  // ...
  this._views.forEach((view) => view.detectChanges());
  // ...
}
            </code></pre>
          </section>
          <section>
            <h1>NgZone</h1>
            <div style="font-size:.65em">Full <a href="https://angular.io/api/core/NgZone" target="_blank">NgZone API</a></div>
            <table style="font-size: .7em; margin-top: 1em;">
              <thead>
                <th>API</th>
                <th>Usage</th>
              </thead>
              <tbody>
                <tr>
                  <td><span class="terminal">onUnstable</span></td>
                  <td>EventEmitter that notifies when code begins to execute in the zone.</td>
                </tr>
                <tr>
                  <td><span class="terminal">onMicrotaskEmpty</span></td>
                  <td>EventEmitter that notifies when microtask queue is empty.  May fire more than once.</td>
                </tr>
                <tr>
                  <td><span class="terminal">onStable</span></td>
                  <td>EventEmitter that notifies when the last onMicrotaskEmpty fires.</td>
                </tr>
                <tr>
                  <td><span class="terminal">run() / runGuarded()</span></td>
                  <td>Execute code within NgZone. Same as zone.js.</td>
                </tr>
                <tr>
                  <td><span class="terminal">runOutsideAngular()</span></td>
                  <td>Execute code within parent zone, will not trigger change detection.</td>
                </tr>
              </tbody>
            </table>
          </section>
          <section>
            <h1>Utilize NgZone</h1>
            <ul>
              <li>Long stack trace enabled by default</li>
              <li>Use APIs to avoid excessive change detection</li>
              <li>runOutsideAngular() when UI updates are not needed</li>
              <li>onStable() to wait for intensive operations</li>
            </ul>
          </section>
        </section>

        <section>
          <h1>Angular Demos</h1>
          <div style="font-size: .7em">
            <a href="https://github.com/dstanich/zonejs-presentation#branches" target="_blank">Source - ngx-examples/</a>
          </div>
        </section>

        <section>
          <h1>Change Detection</h1>
        </section>
      </div>
    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>

    <script>
      // More info about config & dependencies:
      // - https://github.com/hakimel/reveal.js#configuration
      // - https://github.com/hakimel/reveal.js#dependencies
      Reveal.initialize({
        history: true,
        dependencies: [
          { src: 'plugin/markdown/marked.js' },
          { src: 'plugin/markdown/markdown.js' },
          { src: 'plugin/notes/notes.js', async: true },
          { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
        ]
      });
    </script>
  </body>
</html>
